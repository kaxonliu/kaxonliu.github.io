# 文件管理-高级篇



## vi 和 vim

vi 编辑器是基础文本编辑器，vim 是它的增强版。vi 编辑文本的原理是一次性从硬盘读取内容，加载到内存进行编辑，然后保存到硬盘。从它的原理可以知道 vi 适合小文件。



### 三种模式

vi 使用有三种模式，分别是：命令行模式、插入模式、末行模式。

**命令模式（Command Mode）**

- 默认进入 vi 时的初始模式。
- 功能：执行编辑器命令（如复制、粘贴、删除、移动光标等），不能直接输入文本。
- 从其他模式切回命令模式，按 `Esc`。

| **快捷键** | **功能**             | **示例**               |
| :--------- | :------------------- | :--------------------- |
| `dd`       | 删除当前行           | 按 `dd` 删除光标所在行 |
| `3dd`      | 删除当前行往下的3行  |                        |
| `yy`       | 复制当前行           | 按 `yy` 复制，`p` 粘贴 |
| `3yy`      | 复制当前行往下的3行  |                        |
| `p`        | 在光标下一行粘贴内容 |                        |
| `0`        | 数字0光标跳到行首    |                        |
| `$`        | 光标跳到行尾         |                        |
| `gg`       | 光标跳到文件首行     |                        |
| `G`        | 光标跳到文件尾行     |                        |
| `3G`       | 光标跳到第3行        |                        |
| `H`        | 光标跳到屏幕的首行   |                        |
| `M`        | 光标跳到屏幕的中间   |                        |
| `L`        | 光标跳到屏幕的尾行   |                        |
| `u`        | 撤销操作             |                        |

**插入模式（Insert Mode）**
- 功能：直接编辑文本内容。
- 进入方式：在命令模式下按 `i`（光标前插入）、`a`（光标后插入）、`o`（新行插入）等。
- 退出方式：按 `Esc` 返回命令模式。



**末行模式（Ex Mode 或 Last-Line Mode）**
- 功能：执行保存、退出、搜索替换等高级操作。
- 进入方式：在命令模式下按 `:`（冒号）。

| **命令**              | **功能**                                | **说明**                                   |
| :-------------------- | :-------------------------------------- | :----------------------------------------- |
| `:q`                  | 退出 vi                                 | 按 `i` 后开始输入文本                      |
| `:w`                  | 保存                                    | 按 `dd` 删除光标所在行                     |
| `:wq`                 | 保存并退出，等价于 `x`                  | 按 `yy` 复制，`p` 粘贴                     |
| `:!`                  | 强制执行命令                            | 输入 `:q！` 强制退出、`wq!` 强制保存并退出 |
| `:set nu`             | 显示行号                                |                                            |
| `:set nonu`           | 不显示行号                              |                                            |
| `:set hlsearch`       | 设置查询高亮                            |                                            |
| `:set nohlsearch`     | 取消查询高亮                            |                                            |
| `:/查找的字符`        | 查找字符                                | 按 `n` 查找下一个，按 `N` 查找上一个。     |
| `:s/<old>/<new>/`     | 把第1行的内容替换，只替换匹配到的第一个 |                                            |
| `:s/<old>/<new>/g`    | 匹配的全部都替换，使用 `g`              |                                            |
| `:2s/<old>/<new>/g`   | 把第2行的内容做替换                     |                                            |
| `:%s/<old>/<new>/g`   | 把所有行的内容做替换                    |                                            |
| `:/^root/s/bash/ash/` | 使用正则定位，然后做替换操作            |                                            |





## sed

### sed命令基本原理

sed（Stream EDitor，流编辑器）是一个非交互式的文本编辑器，它按行处理输入流（文件或管道输入），执行指定的编辑操作，然后输出结果。其核心工作原理如下：

1. **逐行处理**：sed每次从输入中读取一行到内存；
2. **执行命令**：对内存中的内容执行指定的命令，比如：打印\替换\删除等；
3. **输出结果**：除非指定了不输出（-n选项），否则处理后的内容会默认输出（如果内容被删除了也不输出）；
4. **循环处理**：重复上述过程直到所有行处理完毕



### sed基本用法

#### 命令格式

```bash
sed [选项] '定位规则 + 命令' 输入文件
```

#### 常用选项

| 选项 | 说明                                           |
| :--- | :--------------------------------------------- |
| `-n` | 取消默认输出行为                               |
| `-i` | 直接修改文件内容（慎用，建议先不加 `-i` 测试） |
| `-e` | 指定要执行的命令，可指定多个                   |
| `-r` | 使用扩展正则表达式                             |
| `-f` | 指定包含sed命令的脚本文件                      |

#### 定位规则

**按行匹配**
- 只匹配第一行：`1`
- 连续匹配第一行到第五行：`1,5`

**使用正则匹配**
- 正则匹配的固定结构为：`//`，比如匹配以 `nologin` 结尾的文件 `/nologin/`

**指定行结合正则**
- 匹配从第一行开始到 `nologin`结尾的所有行：`1,/nologin$/`



#### 常用命令

| 命令         | 说明                         |
| :----------- | :--------------------------- |
| `p`          | 打印                         |
| `s///`       | 替换字符串                   |
| `d`          | 删除行                       |
| `i\插入内容` | 在匹配行的前面插入一行       |
| `a\追加内容` | 在匹配行的后面追加一行       |
| `c\新内容`   | 匹配行的内容全部替换为新内容 |

**示例**

~~~bash
# 打印
sed -n '3p' 文件     			# 匹配规则为只操作第3行数据，操作命令为打印。因为取消默认输出，所以看到只打印第3行数据
sed -n '1,5p' 文件   			# 匹配1-5行，打印数据
sed -n '/pattern/p' 文件 	# 打印匹配pattern的行


# 替换
sed 's/原字符串/新字符串/' 文件
sed 's/原字符串/新字符串/g' 文件  # g 表示一行的原字符串全部替换为新字符串
sed 's/原字符串/新字符串/2' 文件  # 只替换每行第二个第二个原字符串


# 删除行
sed '3d' 文件        		# 删除第3行
sed '1,5d' 文件     		# 删除1-5行
sed '/pattern/d' 文件 	# 删除匹配pattern的行


# 插入和追加
sed '3i\插入内容' 文件  # 在第3行前插入
sed '3a\追加内容' 文件  # 在第3行后追加


# 修改行
sed '3c\新内容' 文件    # 替换第3行内容
sed '/pattern/c\新内容' 文件 # 替换匹配行
~~~



### 实用示例
1. 替换文件中的文本（先测试，确认无误再加 `-i`）
   ```bash
   sed 's/old/new/g' file.txt          # 只输出到屏幕
   sed -i 's/old/new/g' file.txt       # 直接修改文件
   ```
2. 删除空白行
   ```bash
   sed '/^$/d' file.txt
   ```
3. 在特定行后插入新的一行
   ```bash
   sed '/pattern/a\插入内容' file.txt
   ```
4. 只替换匹配的行中的字符串
   ```bash
   sed '/pattern/s/old/new/g' file.txt
   ```
5. 使用扩展正则表达式
   ```bash
   sed -r 's/([0-9]{3})/(\1)/' file.txt
   ```
6. 多点编辑（多个命令）
   ```bash
   sed -e 's/old/new/g' -e '/pattern/d' file.txt
   
   # 等价于使用 ; 分隔多条规则
   sed 's/old/new/g;/pattern/d' file.txt
   ```
7. 正则表达式中的特殊字符需要转义
   ~~~bash
   # 把以 sbin/nologin结尾的行中的 sbin/nologin 替换为 bin/bash
   sed '/sbin\/nologin$/s/sbin\/nologin/bin\/bash/g' file.txt
   ~~~



### sed版本

sed 的版本有两大类：GNU sed  和 BSD sed，不同版本的sed可能有细微差异。Centos 和 Ubuntu 上都是 GNU sed；Mac OS 上是 BSD sed

查看 sed 的版本，`sed --version`
- GNU sed 展示信息
  ~~~bash
  sed (GNU sed) 4.2.2
  ~~~
- BSD sed 报错
  ~~~bash
  sed: illegal option -- -
  ~~~



### sed支持管道
~~~bash
ubuntu@master:~$ cat /etc/passwd | sed -n '/^liuxu/p'
liuxu:x:1001:1001::/home/liuxu:/bin/sh
~~~





### 注意 `-i` 选项的行为不同

GNU sed 和 BSD sed 在处理 `-i`（直接修改文件）时有不同。GNU sed：`-i` 可以直接使用，不需要备份。
```bash
sed -i 's/foo/bar/' file.txt
```


BSD sed（macOS）：`-i` 必须带一个备份扩展名（空字符串 `''` 表示不备份），如果直接 `sed -i 's/foo/bar/' file.txt`，会报错。

```bash
sed -i '' 's/foo/bar/' file.txt
```





## awk

