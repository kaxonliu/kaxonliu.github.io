# 进程管理

程序就是静态的代码文件，进程是动态的。进程描述程序执行的过程，这个过程可以大致分为三个主要状态：运行、就绪、阻塞。



## 进程的三大状态

#### 1. 运行（Running）
- **含义**：进程正在 CPU 上执行指令（单核 CPU 同一时间只有一个进程处于运行状态）。
- **触发条件**：被调度器选中，获得 CPU 时间片。
- **退出条件**：
  - 时间片用完（被抢占）。
  - 遇到IO（文件IO、网络IO、sleep、read等）
  - 被更高优先级进程抢占。
- **Linux `STAT` 标志**：`R`（Running 或 Runnable）。



#### 2. 就绪（Ready / Runnable）
- **含义**：进程已准备好运行，但尚未被调度器分配 CPU。
- **触发条件**：
  - 进程初始化完成，等待调度。
  - 从阻塞状态恢复（如 I/O 完成）。
- **特点**：位于内核的 **就绪队列** 中，随时可被调度。
- **Linux `STAT` 标志**：在 `ps` 中仍显示为 `R`（因为 Linux 不严格区分运行和就绪状态）。



#### 3. 阻塞（Blocked / Waiting）
- **含义**：进程因等待某事件（如 I/O、信号量、锁等）而暂停执行。
- **触发条件**：
  - 发起系统调用（如读写磁盘、网络请求）。
  - 请求的资源不可用（如内存不足、锁被占用）。
- **类型**：
  - **可中断睡眠（Interruptible Sleep）**：`STAT = S`
    - 可被信号（如 `SIGKILL`）唤醒。
  - **不可中断睡眠（Uninterruptible Sleep）**：`STAT = D`
    - 通常与硬件 I/O 相关（如磁盘写入），不能被信号中断。
- **退出条件**：等待的事件完成（如数据到达、锁释放）。



#### 状态转换图

~~~
      +-------------------+  
      |     就绪 (R)      |  
      +--------+----------+  
               | ▲  
 调度器分配 CPU | | 时间片用完/抢占  
               ▼ |  
      +--------+----------+  
      |     运行 (R)       |  
      +--------+----------+  
               | ▲  
  等待事件（I/O等）| | 事件完成  
               ▼ |  
      +--------+----------+  
      |    阻塞 (S/D)     |  
      +-------------------+  
~~~



## ps 命令

`ps`（Process Status）是 Linux/Unix 系统中用于查看当前进程状态的常用命令，它可以显示进程的详细信息，如 PID（进程 ID）、CPU 占用、内存使用、运行状态等。



#### 1. 查看当前终端关联的进程

命令：`ps`

~~~bash
[root@centos ~]# ps
  PID TTY          TIME CMD
 4027 pts/0    00:00:00 bash
 4090 pts/0    00:00:00 ps
 
# 字段解释
    # PID：进程 ID
    # TTY：关联的终端
    # TIME：占用 CPU 时间
    # CMD：执行的命令
~~~



#### 2. 查看所有进程状态信息

命令：`ps aux` ，选项含义如下
-  `a` 显示所有用户的进程（包括其他用户）。
- `u` 以用户友好的格式显示（包含 CPU、内存等详细信息）。
- **`x`**：显示没有控制终端的进程（如守护进程）。

~~~bash
[root@centos ~]# ps aux | head -2
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.7  92600  7820 ?        Ss   09:40   0:01 /usr/lib/systemd/systemd
root         2  0.0  0.0      0     0 ?        S    09:40   0:00 [kthreadd]
~~~

展示结果各字段说明：

- **`USER`**：进程所有者。
- **`PID`**：进程ID，pid号。
- **`%CPU`**：CPU 占用率。
- **`%MEM`** 内存占用率
- **`VSZ`**：虚拟内存大小（KB）
- **`RSS`**：实际内存大小（KB）
- **`TTY`**：关联的终端（`?` 表示无终端）
- **`START`**：进程启动时间
- **`TIME`**：进程使用 CPU 的时间
- **`COMMAND`**：进程启动的命令（被 `[]` 包裹的表示内核进程）。
- **`STAT`**：进程当前时刻的状态。很重要。主要有下面这些常见状态标识符。

| `STAT` 标志 | 状态说明                                                     |
| :---------- | :----------------------------------------------------------- |
| R           | 运行态和就绪态                                               |
| S           | 可中断的睡眠状态。                                           |
| D           | 不可中断的睡眠状态。一般和硬盘文件IO紧张有关。               |
| Z           | 僵尸进程（Zombie）。进程已终止已回收了重资源，但父进程未回收其PID/状态等资源。 |
| T           | 进程被信号（如 `SIGSTOP`）暂停。                             |
| `I`         | 空闲（Idle）内核线程空闲中（无任务）。                       |
| `l`         | 多线程进程                                                   |
| +           | 前台运行                                                     |
| s           | 会话领导者。比如 nginx的mater进程                            |
| <           | 高优先级进程                                                 |
| N           | 低优先级进程（`nice > 0`）                                   |



#### 3. 实用用法

**查看父进程编号**

~~~bash
ps -elf
~~~

**按照CPU内存使用率排序**

~~~bash
ps aux --sort=-%cpu | head -10   # 按 CPU 降序（前 10）
ps aux --sort=-%mem | head -10   # 按内存降序（前 10）
~~~



## top 命令

`top` 是 Linux 系统中一个 **实时动态** 查看系统进程和资源使用情况的命令行工具，比 `ps` 更直观，适合监控系统运行状态。

~~~
top - 14:30:45 up 2 days,  3:15,  2 users,  load average: 0.15, 0.10, 0.05
Tasks: 120 total,   2 running, 118 sleeping,   0 stopped,   0 zombie
%Cpu(s):  2.3 us,  0.7 sy,  0.0 ni, 96.8 id,  0.2 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   7856.2 total,   1024.5 free,   4096.3 used,   2735.4 buff/cache
MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.   3248.2 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 1234 root      20   0  320000  45000   8000 S   5.0  0.6   2:30.65 nginx
 5678 mysql     20   0 1200000 300000  20000 S   3.2  3.8  10:15.23 mysqld
~~~

#### 1. top第一行输出信息

top 命令输出的第一行信息中有一个非常重要的指标 **平均负载** `load average`，它的值有三个分别是：近1分钟内的平均负载；近5分钟的平均分在；近15分钟内的平均负载。**平均负载**指的是一段时间内系统中状态是 `R` 和 `D` 的进程的总数。因为负载大和系统运行慢是正相关的，而  `R` 进程和 `D` 进程都是加剧系统压力的进程，所以操作系统把这两个状态都算在 平均负载中了。

**三个平均负载值的趋势可以直观看出来系统运行状态的变化**。有如下几种情况：

- 三个值基本没有变化且值不大。表明系统在平稳运行。
- 三个值依次递增。表明系统过去经历了压力状态目前的负载已经下降。
- 三个值递减，近1分钟的平均负载值达到了CPU的超额状态。表明系统的负载在急剧上升，需要密切关注。



#### 2. top第二行输出信息

top 命令输出的第二行信息是系统目前进程任务的数量，这其中包含僵尸进程。**僵尸进程是操作系统的一种优化机制，僵尸进程是每个进程结束前都要经历的一个状态。僵尸进程其实就是已经死掉的进程，已经被回收了重型资源，但是为了让它的父进程知道这个状态，保留了子进程的状态、PID等消耗资源非常小的信息。保留的目的是为了让其父进程自己管理子进程**。但是有了父进程没有管理这些死掉的子进程，于是系统中就出现了状态为 `Z` 的僵尸进程。如果系统中的僵尸进程数量不多且没有持续增长，此时对系统的影响是极小的。但是如果僵尸进程的数量在急剧持续增长，那就需要立即排查僵尸进程的父进程是哪个。必要时可以把僵尸进程的父进程干掉。

僵尸进程是不能被 `kill` 的，解决它的办法就是把其父进程干掉，**干掉僵尸进程的父进程后，僵尸进程就会被用户态的1号进程接管**（此时僵尸进程的 ppid为1）。因为用户态的1号进程有处理挂掉子进层的能力，所以在很短的时间内就会把这些被接管的僵尸进程回收掉。

#### 3. top第三行输出信息

top命令输出的第三行信息是 CPU 的使用信息。其中：

- `us` 用户态进程占用cpu时间的百分比，不包括低优先级进程的用户态时间（值1-19）
- `sy` 内核态进程占用cpu时间的百分比
- `ni` nice 值为1-19的进程，用户态占cpu时间的百分比
- `id` 系统空闲 cpu 的百分比
- `wa` 系统等待 I/O 的 cpu 时间占比，该时间不计入进程的CPU时间
- `hi` 处理硬件中断所占用CPU的时间，该时间同样不计入进程的CPU时间
- `si` 处理软件中断的时间，该时间不计入进程的CPU时间
- `st` 表示同一宿主机上的其他虚拟机抢走的CPU时间

>补充，`nice` 是 Linux 和 Unix 系统中的一个命令，它可以用来调整进程的优先级。在 Unix-like 系统中，每一个进行CPU调度的任务（包含进程、线程）都有一个对应的 nice 值，这个值决定了其在获得 CPU 时间方面的优先级。nice 值的范围在 -20 到 19，其中 -20 表示最高优先级，而 19 刨示最低优先级。默认情况下，新创建的进程 nice 值是 0。



#### 4. CPU使用率和平均负载

**CPU使用率** 和 **平均负载 **是判断系统稳定的两个非常重要的指标。CPU使用率高表明CPU没有闲着，平均负载高表明系统在处理的任务多。基于这两个指标需要注意下面两种情况：

##### 1. CPU使用率高，平局负载高（R进程多）

此时系统的压力的压力大，因为每个CPU都在不停的干活，如果平均负载等于CPU数量，则处于满额状态。此时正常维护即可。如果平均负载远大于CPU数量，且在不断增加，则系统处理超额状态。此时需要密切注意系统的运行。

##### 2. CPU使用率低，平均负载高（D进程多）

此时平均负载高的原因是不可中断的进程数量多导致的，因为R状态的进程数量少所以 CPU使用率低。此时需要观察硬盘的情况，大量的D状态进程是因为文件IO导致硬盘响应不过来。可能是其他程序在大量的文件IO导致的，也可能是硬盘本省有问题。存储变慢也会拖慢整个系统的运行速度。



#### 5. 常用快捷键

在 `top` 运行时，按以下键进行操作：

| 按键    | 功能                                |
| :------ | :---------------------------------- |
| `q`     | 退出 `top`                          |
| `h`     | 显示帮助                            |
| 数字 1  | 展开CPU使用率数据，每颗CPU单独统计  |
| `d`     | 修改 刷新时间                       |
| `Space` | 立即刷新                            |
| `1`     | 切换显示所有 CPU 核心的使用率       |
| `M`     | 按 **内存** 排序（从高到低）        |
| `P`     | 按 **CPU** 排序（默认）（从高到低） |
| `T`     | 按 **运行时间** 排序（从高到低）    |
| `N`     | 按 **PID** 排序（从高到低）         |
| `R`     | 排序结果反向展示                    |
| `k`     | 杀死进程（输入 PID 后发送信号）     |
| `r`     | 调整进程优先级（`renice`）          |
| `z`     | 彩色/黑白模式切换                   |
| `W`     | 保存当前配置到 `~/.toprc`           |











