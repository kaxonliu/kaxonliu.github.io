# 机房高可用

单个集群架构高可用之后，需要考虑机房级别的高可用。如果把机房看作一个整体，那么它大多数情况下存在单点故障。因此出现了一些跨机房的高可用方案。

想要实现跨机房的高可用，一般有两个基础前提，第一个是机房之间的时间一致，第二个是机房之间使用专线通信（同城专线、跨城专线），减少网络延迟。



## 同城灾备

同城灾备是最简单的跨机房高可用方案，具体可以细分为冷备和热备两种方式。

冷备方案具体为：A 机房为使用的机房，B 机房用来做备份数据，不投入使用。当 A 机房故障时无法直接切到 B 机房让其投入使用，仅从 B 机房恢复数据到 A 机房。

热备方案为：B 机房和 A 机房保持一样，平时也不适用，但是和冷备一样，一致在主从同步数据。当 A 机房故障后，B 机房立即投入使用。A 机房故障后，需要做两件事：1. B 机房的所有从库提升为主库；2. DNS 执行 B 机房，接流量恢复业务。

同城灾备两种方案，都是把 B 机房当作备份，数据从 A 到 B 是单向的主从复制。冷备方案没有高可用效果；热备方案平时不使用 B 机房，浪费成本，且 A 故障时，也不敢轻易切换使用 B 机房（没有使用过怕出问题）。



## 同城双活

顾名思义，该方案指的是在一个城市存在两个活跃使用的机房。A 和 B 两个机房平时都接入流量，既可以分担压力，也可以在平时就验证 B 机房的能力。这样就可以在 A 故障时，放心大胆切到 B 机房。

具体方案细节为：

- A 机房和 B 机房之间使用同城专线。单向主从同步数据。
- 把 B 机房的接入层 IP 加到 DNS 解析中，即 DNS 同时解析 A 和 B 两个解放的 IP 地址。
- 应用层需要做读写分离。A 机房读写都在本机房；B 机房读数据在本机房，写数据到 A 机房的存储层。因为 A 机房的存储层是主库。
- 改造后，B 机房逐步分阶段接入流量，从10% 逐渐覆盖到100%。

因为 B 机房平时接入过流量，验证过它的实战能力。此时如果 A 机房挂掉了，可以放心的把 A 机房的流量切到 B 机房。切换过程为：1. 把 B 机房存储层提升为主库；2. DNS 解析移除 A 机房的 IP



## 两地三中心

同城毕竟可以能遇到城市级别的自然灾害等问题。

两地三中心指的是，在同城双活的基础上，加一个异地冷备中心，定期冷备份数据，

这种架构方案的问题依然是，在主机房挂掉后，异地机房无法直接使用。于是越来越多的互联网公司开始实施异地双活。



## 异地双活

异地双活指的是在两个城市有两个活跃使用的机房。城市间的距离在 1000 公里以上。两个机房之间使用跨城专线同步数据。

#### 伪异地双活

照抄照搬同城双活的方案，只是把两个机房分别放在两个城市，机房之间依然使用单向的主从同步数据。这种方案就是伪造异地双活。

为什么说它伪异地双活？因为 A 地区的用户的请求被转到 B 机房，跨机房的请求，尤其是写数据，延迟非常明显。两个城市之间即使使用跨城专线，但物理距离毕竟是一个需要考虑的核心参数。物理距离远的情况下，再使用单向主从数据同步，它的延迟时间是难以接受的。

北京到上海的距离约为 1300 公里，使用高速网络专线，一个来回也需要近 10 ms 的延迟，再加上网络设备，实际延迟可能再 30ms~100ms，如果网络抖动可能达到 1s，同时多个请求过来，延迟更大。这种延迟难以接受。

#### 异地双活

真正的异地双活要避免跨机房的网络请求，避免延迟问题。因此必须做到每个机房都要读写自己机房的数据。即 A 地区的用户请求读写只发在 A 机房，B 地区用户请求读写只发生在 B 地区。机房之间使用双向主主同步数据。

但是存在一个问题，一个用户的并发请求可能会被 DNS 解析到两个机房，写同一份数据，可能会导致冲突。有两种解决方案。

方案1：数据同步中心开发合并数据、解决冲突的能力。核心为依赖主从机房时间顺序同步。这种感觉不靠谱。

方案2：在 DNS 和 机房接入层直接加一个路由层，按照配置规则把用户分流到固定的机房，从源头避免跨机房。具体配置规则可以有：业务类型、用户ID哈希、地理位置等。



## 异地多活

异地多个活跃的机房。有多种实现方式，建议使用星型同步：即一个中心机房、其他机房都和中心机房同步数据。

常见的方案有两类，分别是网状和星型。

网状的结构指的是，多个机房的储存层相互同步数据，每个机房需要和另外 N-1 个机房同步数据。这样的话，随着扩展的机房越来越多，当一个机房写入数据后，需要同步的机房也越来越多，实现复杂度会比较高。

星型结构指的是，存在一个中心机房，其他机房之间不要同步数据，只需要和中心机房同步数据。此时对中心机房的稳定性要求会比较高。不过还好，中心机房发生故障，可以把任意一个机房提升为中心机房。

多活的优势在于，可以任意扩展机房就近部署，任意机房发生故障，可以快速切换，极大提高系统的可用性。



