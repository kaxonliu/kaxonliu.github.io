# CDN加速



## CDN 是什么

**CDN**，全称为**内容分发网络**，将网络内容分发到边缘网络，其核心目标非常简单：**让用户更快、更稳定地获取网络内容**。CDN 的本质是一个**基于地理分布的分布式网络**，它通过将内容缓存到离用户更近的地方，来提升访问体验。一般都是在流量达到一定的规模的时候才会使用 CDN 加速。

**使用CDN的好处**：1. 让用户更快的访问；2. 减少网站服务器的压力。



## CDN的原理和关键组成

### 域名接管

域名接管就是把需要加速的网站域名（如：example.com）到权威DNS做 `CNAME` 解析，解析到 CDN 服务商提供的专属域名（如：cdn.example.com），这样就把需要加速的网站域名的解析权交给 CDN 服务商。



### GSLB

GSLB（global server load balance）是 CDN 内部的调度器，是 CDN 的核心大脑，由它来计算出分布在全球各地的哪台cdn服务器离用户最近。这个流程如下：
1. 用户发起请求访问 `example.com` 时，本地DNS会最终向 GSLB 发起查询。
2. GSLB会根据一套复杂的策略（包括用户IP地址、网络状况、各节点的负载情况、距离等），综合计算出当前对用户而言**最优的边缘CDN服务器**的IP地址。
3. 这个最优节点的IP地址将被返回给用户。



### 边缘 CDN 服务器

分布在全球各地的 cdn 服务器（也称为边关节点）主要的功能就是缓存热点数据。数据类型包括：静态资源(html、js、css等)，多媒体资源(img、mp3、mp4）等。用户向边缘节点请求数据，会出现两种情况：缓存命中和回源。

- **缓存命中**：如果边缘节点已经缓存了用户请求的内容，则直接返回给用户。**这是最快的情况。**
- **回源**：如果边缘节点没有用户要的内容（比如内容过期或是新内容），它会立即**源数据站点**发起请求，拉取内容。边缘节点从源站获取内容后，一方面会**缓存一份在自己这里**（以便后续其他用户访问），另一方面会**返回给用户**。



### 源数据站点

CDN边缘节点找不到数据时需要到一个存放数据的源头索取数据，这个数据源既可以是对象存储站点，也可以是客户自己的网站。




## CDN 访问流程

使用 cdn 访问加速的流程如下：
1. 用户访问带有被加速域名的静态内容。
2. 被加速域名经本地DNS解析，最终转发到 GSLB 域名。
3. GSLB 经过内部计算，然后分配最佳边缘 cdn 节点的 ip 地址。
4. 用户拿着 ip 地址向比边缘 cdn 发请求，如果边缘 cdn 有缓存则直接响应用户。
5. 如果无缓存则发生回源动作，边缘节点向源数据站点索要数据，拿到数据响应用户，用户再缓存一份。





## 数据源的类型

数据源既可以使用自己的网站，也可以是第三方存储设备，只要可以被 CDN 访问即可。如果是自己的网站，回源时流量就会打到自己的网站上，如果是第三方存储设备则本站无回源流量压力。



### 数据源是存储设备(push cdn)

数据源是存储设备，比如是阿里云的对象存储服务。此时，为了让CDN在命中失败后可以成功溯源，你必须实现主动往数据源里推送好相关数据，这便是 `PUSH CDN`名词的由来，即需要你主动推送数据。

优点：
- 灵活，可以直接指定将哪些内容推送到CDN服务器，该内容何时过期以及何时需要更新。
- 省钱省流量


缺点：
- 配置相对麻烦。梳理出哪些是静态资源，然后在集群中做区分、做转发
- 需要有额外的存储空间才行



### 数据源是本站(pull cdn)

此时不需要你主动push数据到cdn，因为没有任何存储设备给你push。用户首次访问cdn命中失败，开始溯源，就直接请求你的网站获取数据，然后缓存本地+返回给用户。

优点：
- 容易设置，配置主域名解析CNAME到CDN域名就行，你的集群并不需要做配合CDN的配置
- 不需要有CDN以外的额外存储空间

缺点：
- Pull CDN不如Push CDN灵活，你无法定制哪些内容被缓存
- 费钱、冗余流量很常见、很浪费





## 托管 CDN 的形式

CDN加速主要分为两种形式：**局部加速**和**全站加速**。局部加速只要是加速静态内容，将网站的**静态资源**（如图片、视频、CSS、JS、字体文件等）缓存到CDN节点。动态内容（如API接口、用户个人信息）仍然回源站获取。这是最经典、最常用的模式。适合绝大多数网站和App，分离动静资源，成本低，效果显著。**全站加速（动态加速）**不仅缓存静态内容，还对**动态请求**进行加速。通过**最优链路选择**技术，为动态请求建立一条从用户到源站的高速、稳定、低延迟的**传输通道**（专用线路），减少网络抖动和丢包。

>**请注意**：“全站加速”并不是把动态内容缓存起来（那会导致数据错误），而是**优化动态数据的传输路径**。



### 局部 CDN 加速托管流程

主域名使用 `A记录` 解析到网站的负载均衡服务器IP上，加速域名使用 `CNAME` 解析到 CDN 服务商 GSLB 的域名上。网站程序的静态文件都使用加速域名。这样配置后，访问静态图片的流量就会被 CDN 截获。如果程序内部使用的静态文件没有换成加速域名，则需要在本站的负载均衡上配置转发，但是这种做法不如在代码中直接使用加速域名，因为这些流量会打到网站的负载均衡上。

~~~bash
# /etc/nginx/nginx.conf

http {
    upstream web_app_servers {
        server 192.168.71.207:8080 weight=1;
        server 192.168.71.232:8080 weight=1;
        server 192.168.71.231:8080 weight=1;
    }
    server {
        listen 80;
        location / {
            proxy_pass http://web_app_servers;
        }
        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
            proxy_pass http://cdn.example.com;  # CDN URL
        }
    }
}
~~~

### 全站 CDN 加速托管流程

全站加速就会简单很多。直接把网站的主域名原先解析到负载均衡服务器IP 上的 `A记录` 删除，然后把主域名使用 `CNAME` 的方式解析到 GSLB 域名。



## CDN加速OSS资源

当您需要加速OSS上的图片或视频等静态资源时，可以通过阿里云CDN加速OSS域名，实现静态资源的访问加速。

请参考 [阿里云CDN加速OSS资源](https://help.aliyun.com/zh/cdn/use-cases/accelerate-the-retrieval-of-resources-from-an-oss-bucket-in-the-alibaba-cloud-cdn-console)



## CDN 刷新

**强制删除** CDN 边缘节点上已缓存的旧内容。源站上的内容**已经更新**，但CDN节点上缓存着的还是旧内容。这时就需要通过“刷新”操作，让旧缓存立刻失效。可以在CDN控制台按**URL刷新**（精确到某个文件）或**目录刷新**（刷新某个目录下的所有文件）。



## CDN 预热

**主动提前**将指定的内容从源站缓存到 CDN 的边缘节点上。避免**缓存击穿**，提升首批用户体验。预热后，首批用户访问时就能直接从边缘节点命中缓存，获得极速体验，而不用等待回源。在 CDN 控制台提交需要预热的URL，CDN 系统会自动在后台将这些URL的内容从源站拉取到各个节点缓存起来。

