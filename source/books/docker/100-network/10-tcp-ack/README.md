# tcp 重传

tcp 协议是可靠协议，可靠的原因是应答机制。即 ACK 机制。

发送端一个包出去，接收端收到后需要回一个应答确认，在应该确认的包中告诉发送端下一个发送包应该发的数据序列号是多少。发送端收到后就知道可以继续发包了，并且知道了发送包序列号了。这种模式适用于网络正常的环境。

如果网络环境存在延迟、会丢包，会导致发送端长期接收不到 ACK 确认信息。如果干等着，效率必然很低，于是就有了 重传机制。



## 超时重传

RTT。完成一次包的发送与确认实际经历的时间，该时间受网络环境影响可能每次都不一样。

RTO。为RTT设置一个超时时间。

一旦 RTT 时间超过了 RTO，就会触发超时重传机制，发送端会把没有收到确认信息的那个包
重新发一遍。

设置 RTO：

- RTO 不能设置的过大，重发就慢，丢了老半天才重发，没有效率，性能差；
- RTO 也不能设置的过小，会导致可能并没有丢就重发，于是重发的就快，会增加网络拥塞，导致更多的超时，更多的超时导致更多的重发。

RTO 的时间应该综合考虑网络情况，以完成一次正常的发送与确认经历的RTT时间为准。RTO 设置的必 RTT 稍大一点。

如果超时重发的数据，再次超时的时候，又需要重传的时候，TCP 的策略是超时间隔加倍。也就是每当遇到一次超时重传的时候，都会将下一次超时时间间隔设为先前值的两倍。两次超时，就说明网络环境差，不宜频繁反复发送。



## 快重传

快速重传的工作方式是当收到三个相同的 ACK 报文时，会在定时器过期之前，重传丢失的报文段。

SACK
D-SACK



## 滑动窗口

发送窗口、接收窗口
	为了解决每发送一个数据包都要等到确认信息之后才能发送下一个这个问题，TCP引入了滑动窗口的概念

什么是窗口？
	窗口的实现实际上就是操作系统开辟的一个缓存空间，发送方主机在等到确认应答之前
	必须在自己的缓冲区里保留发送过的数据，如果按期收到了确认应答，此时数据就可以从缓存
	区里删除了






​	
4、流量控制


5、拥塞控制



四、重传现象
	1、超时重传
	2、快重传：连续三次收到相同的ack确认信息
	
	3、没收到一个SACK信息
		发送端都会计算：接收端已经收到的数据和未收到的数据的差值
		如果该差值过大，也会触发重传
		
		乱序包可能就会引发上面的问题


​		
	其实在容器平台里：乱序包问题+SACK+每次接收到SACK之后都会计算接收端已经收到的数据和未收到的数据的差值




五、为何在容器平台里乱序包问题会被放大

	容器与外部通信是通过veth设备的
	
	当容器向外发送数据包时，会由容器的eth0网卡送到对应宿主机上的veth设备
	
	而宿主上对应的veth设备在接收容器发来的数据包时，会模拟物理网卡接收的数据包的过程


​	